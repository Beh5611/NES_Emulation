// PPU stuff
#ifndef PPU_H
#define PPU_H
#include <cstdint>
#include <cstddef>
#include "memory.h"


typedef union{
    struct {
    //  Vblank NMI enable (0: off, 1: on)
    uint8_t V: 1; 
    // PPU master/slave select
    //(0: read backdrop from EXT pins; 1: output color on EXT pins)
    uint8_t P: 1;
    // Sprite size (0: 8x8 pixels; 1: 8x16 pixels â€“ see PPU OAM#Byte 1)
    uint8_t H: 1; 
    // Background pattern table address (0: $0000; 1: $1000)
    uint8_t B: 1; 
    // Sprite pattern table address for 8x8 sprites
    //  (0: $0000; 1: $1000; ignored in 8x16 mode)
    uint8_t S: 1; 
    // VRAM address increment per CPU read/write of PPUDATA
    // (0: add 1, going across; 1: add 32, going down)
    uint8_t I: 1;
    // base name table address
    // (0 = $2000; 1 = $2400; 2 = $2800; 3 = $2C00)
    uint8_t Nx: 1; 
    uint8_t Ny: 1;

    };

    uint8_t flags;

} PPUCtrl;

typedef union {
    struct{ 
    // Emphasize blue
    char B: 1;
    // Emphasize green (red on PAL/Dendy)
    char G: 1;
    // Emphasize red (green on PAL/Dendy)
    char R: 1;
    // 1: Enable sprite rendering
    char s: 1;
    // 1: Enable background rendering
    char b: 1;
    // 1: Show sprites in leftmost 8 pixels of screen, 0: Hide
    char M: 1;
    // 1: Show background in leftmost 8 pixels of screen, 0: Hide
    char m: 1;
    // Greyscale (0: normal color, 1: greyscale)
    char Gs: 1;
};
uint8_t flags;
} PPUMask;

typedef union{

    struct {
    // Vblank flag, cleared on read
    char V: 1;
    // Sprite 0 hit flag
    char S: 1;
    // Sprite overflow flag
    char O: 1;
    };
    uint8_t flags;

} PPUStatus;



class PPU: public IMemory{
    private: 
        uint8_t vram[16 * 1024];
        uint8_t spr_ram[256];

    
    public:
        PPU();
        PPUCtrl ppu_ctrl;
        PPUMask ppu_mask;
        PPUStatus ppu_status;
        uint8_t oam_addr;
        uint8_t oam_data;
        uint16_t ppu_scroll;
        uint16_t ppu_addr;
        uint16_t ppu_data;

        uint8_t oam_dma;
        // mmio registers
        uint8_t ppu_gen_latch;        
        //internal registers
        uint16_t v; 
        uint16_t t;
        uint8_t x;
        uint8_t w;

        // palette color 
         const unsigned char PaletteLUT_2C04_0001 [64] ={
            0x35,0x23,0x16,0x22,0x1C,0x09,0x1D,0x15,0x20,0x00,0x27,0x05,0x04,0x28,0x08,0x20,
            0x21,0x3E,0x1F,0x29,0x3C,0x32,0x36,0x12,0x3F,0x2B,0x2E,0x1E,0x3D,0x2D,0x24,0x01,
            0x0E,0x31,0x33,0x2A,0x2C,0x0C,0x1B,0x14,0x2E,0x07,0x34,0x06,0x13,0x02,0x26,0x2E,
            0x2E,0x19,0x10,0x0A,0x39,0x03,0x37,0x17,0x0F,0x11,0x0B,0x0D,0x38,0x25,0x18,0x3A
        };

        // const unsigned char PaletteLUT_2C04_0002 [64] ={
        //     0x2E,0x27,0x18,0x39,0x3A,0x25,0x1C,0x31,0x16,0x13,0x38,0x34,0x20,0x23,0x3C,0x0B,
        //     0x0F,0x21,0x06,0x3D,0x1B,0x29,0x1E,0x22,0x1D,0x24,0x0E,0x2B,0x32,0x08,0x2E,0x03,
        //     0x04,0x36,0x26,0x33,0x11,0x1F,0x10,0x02,0x14,0x3F,0x00,0x09,0x12,0x2E,0x28,0x20,
        //     0x3E,0x0D,0x2A,0x17,0x0C,0x01,0x15,0x19,0x2E,0x2C,0x07,0x37,0x35,0x05,0x0A,0x2D
        // };

        // const unsigned char PaletteLUT_2C04_0003 [64] ={
        //     0x14,0x25,0x3A,0x10,0x0B,0x20,0x31,0x09,0x01,0x2E,0x36,0x08,0x15,0x3D,0x3E,0x3C,
        //     0x22,0x1C,0x05,0x12,0x19,0x18,0x17,0x1B,0x00,0x03,0x2E,0x02,0x16,0x06,0x34,0x35,
        //     0x23,0x0F,0x0E,0x37,0x0D,0x27,0x26,0x20,0x29,0x04,0x21,0x24,0x11,0x2D,0x2E,0x1F,
        //     0x2C,0x1E,0x39,0x33,0x07,0x2A,0x28,0x1D,0x0A,0x2E,0x32,0x38,0x13,0x2B,0x3F,0x0C
        // };

        // const unsigned char PaletteLUT_2C04_0004 [64] ={
        //     0x18,0x03,0x1C,0x28,0x2E,0x35,0x01,0x17,0x10,0x1F,0x2A,0x0E,0x36,0x37,0x0B,0x39,
        //     0x25,0x1E,0x12,0x34,0x2E,0x1D,0x06,0x26,0x3E,0x1B,0x22,0x19,0x04,0x2E,0x3A,0x21,
        //     0x05,0x0A,0x07,0x02,0x13,0x14,0x00,0x15,0x0C,0x3D,0x11,0x0F,0x0D,0x38,0x2D,0x24,
        //     0x33,0x20,0x08,0x16,0x3F,0x2B,0x20,0x3C,0x2E,0x27,0x23,0x31,0x29,0x32,0x2C,0x09
        // };

        uint8_t read(uint16_t addr) override;
        void write(uint16_t addr, uint8_t data) override;
        void generate_background();

};

#endif